#!/bin/#!/bin/bash

aide(){
	echo "Le script premet de filtrer les donneés d'un fichier, crée un fichier qui contient une liste avec toutes les stations et d'autres inforations (somme des consommateurs etc)"
	echo " $0 <chemin_csv> <type_station> <type_conso> [<id_centrale>][-h]" # les crochets sont utilisés pour dire que largument est optionnel
	echo "Paramètres :"
    	echo "  <chemin_csv>       :  Chemin vers le fichier de données CSV (obligatoire)"
    	echo "  <type_station>     : Type de station à traiter : hvb, hva ou lv (obligatoire)"
    	echo "  <type_conso>       : Type de consommateur à analyser : comp, indiv, all (obligatoire)"
    	echo "Restrictions :"
    	echo "   hvb   \t   : seulement comp (entreprises)"
    	echo "   hva \t   : seulement comp (entreprises)"
    	echo "   lv   \t   : comp, indiv (particuliers) ou all (tous)"
    	echo "  <id_centrale>      : Identifiant de la centrale (optionnel)"
    	echo "Options interdites :"
    	echo " hvb all, hvb indiv, hva all, hva indiv"
    	echo "  -h                 : Affiche cette aide (prioritaire)"
	exit 0
} 

if [[ "$#" -lt 3 || "$*" == *"-h"* ]]; then #si l'option -h est demandé quelque soit l'endroit ou si le nombre d'argument est inferieur a trois 
	aide
	exit 1
fi

chemin_fichier=$1
station=$2
conso=$3
id_centrale=$4

# Validation des paramètres
if [[ ! -f "$chemin_fichier" ]]; then
    echo "Erreur : Le fichier CSV '$chemin_fichier' n'existe pas."
    aide
    echo "temps : 0.0sec"
    exit 2
fi

if [[ "$station" != "hvb" && "$station" != "hva" && "$station" != "lv" ]]; then
    echo "Erreur : La station saisie n'existe pas. Valeurs possibles : hvb, hva, lv."
    aide
    echo "temps : 0.0sec"
    exit 3
fi

if [[ "$conso" != "comp" && "$conso" != "indiv" && "$conso" != "all" ]]; then
    echo "Erreur : Le consommateur saisi n'existe pas. Valeurs possibles : comp, indiv, all."
    aide
    exit 4
fi

# Vérifications des restrictions spécifiques
if [[ "$station" == "hvb" && ( "$conso" == "all" || "$conso" == "indiv" ) ]]; then
    echo "Erreur : Les options 'hvb all' et 'hvb indiv' sont interdites."
    aide
    echo "temps : 0.0sec"
    exit 5
fi
if [[ "$station" == "hva" && ( "$conso" == "all" || "$conso" == "indiv" ) ]]; then
    echo "Erreur : Les options 'hva all' et 'hva indiv' sont interdites."
    aide
    echo "temps : 0.0sec"
    exit 6
fi

# Vérification et création des dossiers temporaires
if [[ -d "tmp" ]]; then
    echo "Le dossier 'tmp' existe déjà. Il sera vidé."
    rm -rf tmp/* # Supprime tout ce qui est à l'intérieur
else
    echo "Le dossier 'tmp' n'existe pas. Création du dossier."
    mkdir -p tmp
fi

if [[ -d "graphs" ]]; then
    echo "Le dossier 'graphs' existe déjà."
else
    echo "Le dossier 'graphs' n'existe pas. Création du dossier."
    mkdir -p graphs
fi

# Vérification de l'exécutable C
executable="./C-Wire_pg" 
if [[ ! -f "$executable" ]]; then
    echo "Compilation du programme C..."
    make -C C-Wire
    if [[ $? -ne 0 ]]; then
        echo "Erreur : Échec de la compilation du programme C."
        echo "temps : 0.0sec"
        exit 7
    fi
fi

# Fonction pour mesurer le temps
mesurer_temps() {
    local temp_debut=$(date +%s.%N)
    "$@"
    local temp_fin=$(date +%s.%N)
    local temp_ecoule=$(awk "BEGIN {print $temp_fin - $temp_debut}")
    printf "Temps d'exécution : %.3f sec\n" "$temp_ecoule"
}

# Fonction de filtrage
filtrer_copier() {
    local fichier_entree="$1"
    local station_type="$2"
    local consommateur_type="$3"
    local central_id="$4"
    local fichier_sortie="tmp/filtered_data.dat"

    echo "Filtrage des données en fonction du type de station, du type de consommateur et de l'ID de la centrale..."

    local station_index consommateur_index
    case "$station_type" in
        hvb) station_index=2 ;;
        hva) station_index=3 ;;
        lv) station_index=4 ;;
    esac

    case "$consumer_type" in
        comp) consommateur_index=5 ;;
        indiv) consommateur_index=6 ;;
        all) consommateur_index="all" ;;
    esac

    if [[ "$consommateur_index" == 5 ]]; then
        local no_consommateur=6
    else
        local no_consommateur=5
    fi

    awk -v station_idx=$station_index -v cons_idx=$consommateur_index -v no_cons_idx=$no_consommateur -v central_id=$central_id \
    'BEGIN { FS=","; OFS="," } \
    NR==1 || ($station_idx == central_id && $cons_idx != "") { print $0 }' $fichier_entree > $fichier_sortie

    echo "Données filtrées copiées dans : $fichier_sortie"
}

# Mesurer et exécuter le filtrage
mesurer_temps filtrer_copier "$chemin_fichier" "$station" "$conso" "$id_centrale"
